<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>ABG Interpreter</title>
  <meta name="description" content="ABG interpreter: primary disorder, compensation checks, and optional A‚Äìa gradient & anion gap tools (decision-support only)." />

  <!-- Apply saved theme before paint -->
  <script>
    (function () {
      const t = localStorage.getItem('theme'); // "dark" | "light" | "system" | null
      if (t === 'dark' || t === 'light') {
        document.documentElement.setAttribute('data-theme', t);
        document.documentElement.style.colorScheme = t;
      } else {
        document.documentElement.removeAttribute('data-theme');
        document.documentElement.style.colorScheme = '';
      }
    })();
  </script>

  <style>
    /* =============== THEME TOKENS =============== */
    :root{
      --bg: #0b1220;
      --surface: rgba(255,255,255,.06);
      --surface-2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --border: rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.25);
      --accent: #7c5cff;
      --accent-2:#16c2a1;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --ok:#6ee7b7;
      --radius: 18px;
      --radius-sm: 14px;
      --max: 1100px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb;
      --surface: rgba(17,24,39,.05);
      --surface-2: rgba(17,24,39,.08);
      --text: rgba(17,24,39,.92);
      --muted: rgba(17,24,39,.7);
      --border: rgba(17,24,39,.12);
      --shadow: 0 12px 30px rgba(17,24,39,.10);
      --accent:#5b5cff;
      --accent-2:#0fb49a;
      --warn:#c07a00;
      --danger:#c2410c;
      --ok:#047857;
    }
    @media (prefers-color-scheme: light){
      :root:not([data-theme]){
        --bg:#f6f7fb;
        --surface: rgba(17,24,39,.05);
        --surface-2: rgba(17,24,39,.08);
        --text: rgba(17,24,39,.92);
        --muted: rgba(17,24,39,.7);
        --border: rgba(17,24,39,.12);
        --shadow: 0 12px 30px rgba(17,24,39,.10);
        --accent:#5b5cff;
        --accent-2:#0fb49a;
        --warn:#c07a00;
        --danger:#c2410c;
        --ok:#047857;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(900px 400px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(900px 400px at 90% 0%, rgba(22,194,161,.28), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(255,204,102,.15), transparent 60%),
        var(--bg);
      line-height: 1.35;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:var(--max); margin:0 auto; padding:22px 16px 44px;}

    /* Header */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .left{display:flex; align-items:center; gap:10px; min-width: 220px;}
    .logo{
      width:38px; height:38px; border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .logo svg{opacity:.95}
    .titles h1{font-size:15px; margin:0; letter-spacing:.2px}
    .titles p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--text);
      border-radius: 999px;
      padding: 9px 12px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.06)}
    .btn:active{transform: translateY(1px)}
    .btn[data-mode]::after{
      content: attr(data-mode);
      margin-left: 2px;
      font-size: 12px;
      line-height: 1;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--muted);
    }
    .ghost{
      border:1px solid var(--border);
      background:transparent;
      color: var(--muted);
    }
    .ghost:hover{color: var(--text)}
    .linkpill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      padding: 9px 12px;
      border-radius:999px;
      color: var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    .linkpill:hover{color: var(--text); background: rgba(255,255,255,.06)}

    /* Hero */
    .hero{
      margin-top:14px;
      padding:18px 18px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
    }
    .hero h2{margin:0; font-size: 18px;}
    .hero p{margin:8px 0 0; color: var(--muted); max-width: 95ch; font-size: 13.5px;}
    .note{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed var(--border);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 12.5px;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .panel{
      grid-column: span 6;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .panel.full{grid-column: span 12;}
    @media (max-width: 900px){
      .panel{grid-column: span 12;}
      .left{min-width:unset}
    }
    .panel h3{
      margin:0 0 10px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .25px;
      color: var(--muted);
    }

    /* Form */
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .row.three{grid-template-columns: 1fr 1fr 1fr;}
    @media (max-width: 680px){
      .row, .row.three{grid-template-columns: 1fr;}
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    input, select{
      width:100%;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--text);
      outline: none;
    }
    input::placeholder{color: var(--muted)}
    input:focus, select:focus{
      border-color: rgba(124,92,255,.45);
      box-shadow: 0 0 0 3px rgba(124,92,255,.12);
    }
    .help{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    /* Results */
    .results{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .metric{
      grid-column: span 6;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      position:relative;
      overflow:hidden;
    }
    .metric.full{grid-column: span 12;}
    .metric h4{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .metric .value{
      margin-top:6px;
      font-size: 18px;
      font-weight: 800;
    }
    .metric .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      white-space: pre-line;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top: 10px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      width: fit-content;
    }
    .badge.ok{border-color: rgba(22,194,161,.35); color: var(--text)}
    .badge.warn{border-color: rgba(255,204,102,.35); color: var(--text)}
    .badge.danger{border-color: rgba(255,107,107,.35); color: var(--text)}

    .hr{
      height: 1px;
      background: var(--border);
      margin: 14px 0;
    }

    details{
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
    }
    summary{
      cursor:pointer;
      color: var(--muted);
      font-size: 12.5px;
      list-style: none;
    }
    summary::-webkit-details-marker{display:none;}
    details p, details li{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }
    ul{margin: 6px 0 0 18px; padding:0;}

    .footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      padding: 0 2px;
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.18);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12.5px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      backdrop-filter: blur(10px);
    }
    :root[data-theme="light"] .toast{
      background: rgba(17,24,39,.75);
      border-color: rgba(255,255,255,.12);
    }
    .toast.show{opacity:1;}
  </style>
</head>

<body>
  <div class="container">
    <header class="topbar">
      <div class="left">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M6 14c0-4.5 3.6-8 8-8h3" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 14c0 3.3 2.7 6 6 6h5" stroke="white" stroke-width="2" stroke-linecap="round" opacity=".9"/>
            <path d="M16.5 6.5h3v3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="6" cy="14" r="2" fill="white" opacity=".95"/>
          </svg>
        </div>
        <div class="titles">
          <h1>ABG Interpreter</h1>
          <p>Primary disorder, compensation, and optional A‚Äìa gradient / anion gap</p>
        </div>
      </div>

      <div class="actions">
        <a class="linkpill" href="index.html">‚Üê Home</a>
        <button class="btn ghost" id="resetBtn" type="button" title="Reset inputs">‚Ü∫ Reset</button>
        <button class="btn" id="themeBtn" type="button" title="Theme: System (click to change)">
          <span aria-hidden="true">üñ•Ô∏è</span> Theme
        </button>
      </div>
    </header>

    <section class="hero">
      <h2>Structured ABG interpretation at the bedside</h2>
      <p>
        Enter pH, PaCO‚ÇÇ, HCO‚ÇÉ‚Åª, PaO‚ÇÇ, and FiO‚ÇÇ. This tool estimates the <b>primary disorder</b>,
        checks <b>expected compensation</b>, and can calculate <b>A‚Äìa gradient</b> and <b>P/F ratio</b>.
        Optional labs enable <b>anion gap</b> and <b>delta gap</b>.
      </p>
      <div class="note">
        <b>Decision-support only.</b> Results depend on assumptions and may not apply in all clinical contexts
        (e.g., mixed disorders, ventilator changes, chronic CO‚ÇÇ retention, altitude). Verify clinically.
      </div>
    </section>

    <div class="grid">
      <!-- Inputs -->
      <section class="panel" aria-label="Inputs">
        <h3>Inputs</h3>

        <div class="row">
          <div>
            <label for="ph">pH</label>
            <input id="ph" type="number" inputmode="decimal" step="0.01" min="6.8" max="7.8" placeholder="e.g., 7.32" />
          </div>
          <div>
            <label for="paco2">PaCO‚ÇÇ (mmHg)</label>
            <input id="paco2" type="number" inputmode="decimal" step="1" min="10" max="120" placeholder="e.g., 52" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="hco3">HCO‚ÇÉ‚Åª (mEq/L)</label>
            <input id="hco3" type="number" inputmode="decimal" step="0.1" min="2" max="60" placeholder="e.g., 24.0" />
          </div>
          <div>
            <label for="pao2">PaO‚ÇÇ (mmHg)</label>
            <input id="pao2" type="number" inputmode="decimal" step="1" min="10" max="600" placeholder="e.g., 90" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="fio2">FiO‚ÇÇ</label>
            <input id="fio2" type="number" inputmode="decimal" step="0.01" min="0.21" max="1" placeholder="e.g., 0.50" />
            <div class="help">Enter fraction 0.21‚Äì1.0. If you type 50, it will be interpreted as 0.50.</div>
          </div>
          <div>
            <label for="age">Age (optional, years)</label>
            <input id="age" type="number" inputmode="numeric" step="1" min="0" max="120" placeholder="e.g., 65" />
          </div>
        </div>

        <details>
          <summary>Advanced oxygenation settings (optional)</summary>
          <div class="row three" style="margin-top:10px;">
            <div>
              <label for="pb">Barometric pressure Pb (mmHg)</label>
              <input id="pb" type="number" inputmode="decimal" step="1" min="500" max="800" value="760" />
            </div>
            <div>
              <label for="ph2o">Water vapor PH‚ÇÇO (mmHg)</label>
              <input id="ph2o" type="number" inputmode="decimal" step="1" min="0" max="80" value="47" />
            </div>
            <div>
              <label for="rq">Respiratory quotient RQ</label>
              <input id="rq" type="number" inputmode="decimal" step="0.01" min="0.6" max="1.2" value="0.80" />
            </div>
          </div>
          <p>Defaults assume sea level and typical RQ. Adjust if needed for your context.</p>
        </details>

        <details>
          <summary>Anion gap & delta gap (optional labs)</summary>
          <p style="margin-top:10px;">
            Enter sodium and chloride to calculate anion gap: <b>AG = Na ‚àí (Cl + HCO‚ÇÉ)</b>.
            Albumin can provide an albumin-corrected AG (rule-of-thumb correction).
          </p>
          <div class="row three">
            <div>
              <label for="na">Na (mEq/L)</label>
              <input id="na" type="number" inputmode="decimal" step="1" min="90" max="190" placeholder="e.g., 140" />
            </div>
            <div>
              <label for="cl">Cl (mEq/L)</label>
              <input id="cl" type="number" inputmode="decimal" step="1" min="50" max="140" placeholder="e.g., 104" />
            </div>
            <div>
              <label for="alb">Albumin (g/dL)</label>
              <input id="alb" type="number" inputmode="decimal" step="0.1" min="0" max="6" placeholder="e.g., 3.0" />
            </div>
          </div>
          <p>
            Albumin correction (rule-of-thumb): <b>AG<sub>corr</sub> ‚âà AG + 2.5 √ó (4.0 ‚àí albumin)</b>.
            Delta gap (rule-of-thumb): <b>(AG ‚àí 12) / (24 ‚àí HCO‚ÇÉ)</b>.
          </p>
        </details>

        <div class="hr"></div>

        <button class="btn" id="copyBtn" type="button" title="Copy a one-line summary">
          üìã Copy summary
        </button>

        <details>
          <summary>Compensation formulas used</summary>
          <ul>
            <li><b>Metabolic acidosis:</b> Winter‚Äôs expected PaCO‚ÇÇ ‚âà 1.5√óHCO‚ÇÉ + 8 (¬±2).</li>
            <li><b>Metabolic alkalosis:</b> expected PaCO‚ÇÇ ‚âà 0.7√ó(HCO‚ÇÉ‚àí24)+40 (¬±5).</li>
            <li><b>Respiratory acidosis:</b> expected HCO‚ÇÉ change per +10 PaCO‚ÇÇ:
              acute +1; chronic +3.5 (rule-of-thumb).</li>
            <li><b>Respiratory alkalosis:</b> expected HCO‚ÇÉ change per ‚àí10 PaCO‚ÇÇ:
              acute ‚àí2; chronic ‚àí4 (rule-of-thumb).</li>
            <li><b>A‚Äìa gradient:</b> PAO‚ÇÇ = FiO‚ÇÇ√ó(Pb‚àíPH‚ÇÇO) ‚àí (PaCO‚ÇÇ/RQ); A‚Äìa = PAO‚ÇÇ ‚àí PaO‚ÇÇ.</li>
            <li><b>Expected A‚Äìa (age rule-of-thumb):</b> ‚âà age/4 + 4 (mmHg).</li>
          </ul>
        </details>
      </section>

      <!-- Outputs -->
      <section class="panel" aria-label="Results">
        <h3>Interpretation</h3>

        <div class="results">
          <div class="metric">
            <h4>Acid‚Äìbase status</h4>
            <div class="value" id="statusOut">‚Äî</div>
            <div class="sub" id="statusSub">Enter values to interpret.</div>
          </div>

          <div class="metric">
            <h4>Primary process (best fit)</h4>
            <div class="value" id="primaryOut">‚Äî</div>
            <div class="sub" id="primarySub">‚Äî</div>
          </div>

          <div class="metric full">
            <h4>Compensation check</h4>
            <div class="value" id="compOut">‚Äî</div>
            <div class="sub" id="compSub">‚Äî</div>
            <div class="badge" id="compBadge">Awaiting inputs‚Ä¶</div>
          </div>

          <div class="metric">
            <h4>Oxygenation</h4>
            <div class="value" id="pfOut">‚Äî</div>
            <div class="sub" id="oxySub">P/F ratio (PaO‚ÇÇ/FiO‚ÇÇ) shown when both entered.</div>
          </div>

          <div class="metric">
            <h4>A‚Äìa gradient (optional)</h4>
            <div class="value" id="aaOut">‚Äî</div>
            <div class="sub" id="aaSub">Requires PaO‚ÇÇ, PaCO‚ÇÇ, FiO‚ÇÇ.</div>
          </div>

          <div class="metric full">
            <h4>Anion gap (optional)</h4>
            <div class="value" id="agOut">‚Äî</div>
            <div class="sub" id="agSub">Requires Na, Cl, HCO‚ÇÉ.</div>
          </div>

          <div class="metric full">
            <h4>Copy preview</h4>
            <div class="sub" id="copyPreview">Fill in ABG values to generate a summary.</div>
          </div>
        </div>
      </section>

      <section class="panel full" aria-label="Notes">
        <h3>Bedside notes (non-prescriptive)</h3>
        <p style="margin:0;color:var(--muted);font-size:13px;max-width:105ch;">
          ‚Ä¢ Compensation rules are approximations; acute ventilator changes and chronic respiratory disease can mislead ‚Äúbest fit‚Äù logic.<br/>
          ‚Ä¢ Consider lactate, ketones, toxidromes, renal function, and clinical trajectory for metabolic processes.<br/>
          ‚Ä¢ On high FiO‚ÇÇ, A‚Äìa can be large even with modest shunt; interpret with clinical context and ventilation/perfusion factors.
        </p>
      </section>
    </div>

    <div class="footer">
      <div>¬© <span id="year"></span> ABG Interpreter ‚Ä¢ Local-only HTML</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <a class="linkpill" href="index.html">‚Üê Back to Home</a>
        <a class="linkpill" href="#" id="scrollTop">‚Üë Top</a>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">Copied!</div>

  <script>
    // =============================
    // THEME: Dark -> Light -> System
    // =============================
    const themeBtn = document.getElementById('themeBtn');

    function getSavedTheme(){
      const t = localStorage.getItem('theme');
      return (t === 'dark' || t === 'light' || t === 'system') ? t : 'system';
    }
    function updateThemeButton(mode){
      const icon = (mode === 'dark') ? 'üåô' : (mode === 'light') ? '‚òÄÔ∏è' : 'üñ•Ô∏è';
      const label = (mode === 'dark') ? 'Dark' : (mode === 'light') ? 'Light' : 'System';
      themeBtn.querySelector('span').textContent = icon;
      themeBtn.setAttribute('data-mode', label);
      themeBtn.title = `Theme: ${label} (click to change)`;
      themeBtn.setAttribute('aria-label', `Theme: ${label}. Click to switch theme.`);
    }
    function applyTheme(mode){
      if (mode === 'dark' || mode === 'light') {
        document.documentElement.setAttribute('data-theme', mode);
        document.documentElement.style.colorScheme = mode;
      } else {
        document.documentElement.removeAttribute('data-theme');
        document.documentElement.style.colorScheme = '';
      }
      localStorage.setItem('theme', mode);
      updateThemeButton(mode);
    }
    updateThemeButton(getSavedTheme());
    themeBtn?.addEventListener('click', () => {
      const current = getSavedTheme();
      const next = (current === 'dark') ? 'light' : (current === 'light') ? 'system' : 'dark';
      applyTheme(next);
    });
    if (window.matchMedia) {
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener?.('change', () => {
        if (getSavedTheme() === 'system') updateThemeButton('system');
      });
    }

    // =============================
    // ABG LOGIC
    // =============================
    const els = {
      ph: document.getElementById('ph'),
      paco2: document.getElementById('paco2'),
      hco3: document.getElementById('hco3'),
      pao2: document.getElementById('pao2'),
      fio2: document.getElementById('fio2'),
      age: document.getElementById('age'),

      pb: document.getElementById('pb'),
      ph2o: document.getElementById('ph2o'),
      rq: document.getElementById('rq'),

      na: document.getElementById('na'),
      cl: document.getElementById('cl'),
      alb: document.getElementById('alb'),

      statusOut: document.getElementById('statusOut'),
      statusSub: document.getElementById('statusSub'),
      primaryOut: document.getElementById('primaryOut'),
      primarySub: document.getElementById('primarySub'),
      compOut: document.getElementById('compOut'),
      compSub: document.getElementById('compSub'),
      compBadge: document.getElementById('compBadge'),

      pfOut: document.getElementById('pfOut'),
      oxySub: document.getElementById('oxySub'),
      aaOut: document.getElementById('aaOut'),
      aaSub: document.getElementById('aaSub'),

      agOut: document.getElementById('agOut'),
      agSub: document.getElementById('agSub'),

      copyPreview: document.getElementById('copyPreview'),
      copyBtn: document.getElementById('copyBtn'),
      resetBtn: document.getElementById('resetBtn'),
      toast: document.getElementById('toast')
    };

    function isNum(x){ return Number.isFinite(x); }
    function n(el){
      const v = parseFloat(el.value);
      return Number.isFinite(v) ? v : NaN;
    }
    function round(x, d=1){
      const p = Math.pow(10,d);
      return Math.round(x*p)/p;
    }
    function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }

    function fmtFiO2(v){
      if (!isNum(v)) return '';
      if (v > 1) v = v/100; // interpret percent
      return round(v,2).toFixed(2);
    }

    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => els.toast.classList.remove('show'), 900);
    }

    function acidBaseStatus(ph){
      if (!isNum(ph)) return {label:'‚Äî', sub:'Enter values to interpret.'};
      if (ph < 7.35) return {label:'Acidemia', sub:'pH < 7.35'};
      if (ph > 7.45) return {label:'Alkalemia', sub:'pH > 7.45'};
      return {label:'Near-normal pH', sub:'pH 7.35‚Äì7.45 (mixed disorder possible)'};
    }

    function bestFitPrimary(ph, paco2, hco3){
      // Determine "best fit" using directionality vs normal values (40, 24).
      if (!isNum(ph) || !isNum(paco2) || !isNum(hco3)) {
        return {primary:'‚Äî', sub:'Enter pH, PaCO‚ÇÇ, and HCO‚ÇÉ‚Åª.'};
      }
      const acid = ph < 7.35;
      const alk = ph > 7.45;

      const dCO2 = paco2 - 40;
      const dHCO3 = hco3 - 24;

      // Helper: which component aligns with pH?
      // In acidemia: high CO2 supports respiratory acidosis; low HCO3 supports metabolic acidosis
      // In alkalemia: low CO2 supports respiratory alkalosis; high HCO3 supports metabolic alkalosis
      const respSupports = acid ? (dCO2 > 0) : alk ? (dCO2 < 0) : null;
      const metSupports  = acid ? (dHCO3 < 0) : alk ? (dHCO3 > 0) : null;

      // Near-normal pH: choose by larger deviation magnitude; flag mixed.
      if (!acid && !alk){
        const co2Mag = Math.abs(dCO2);
        const hco3Mag = Math.abs(dHCO3);
        const likely = (co2Mag > hco3Mag)
          ? (dCO2 > 0 ? 'Respiratory acidosis predominance' : 'Respiratory alkalosis predominance')
          : (dHCO3 > 0 ? 'Metabolic alkalosis predominance' : 'Metabolic acidosis predominance');
        return {primary:likely, sub:'Near-normal pH: consider mixed disorders (both processes may be present).'};
      }

      if (respSupports && metSupports){
        return {primary:'Mixed process likely', sub:'Both PaCO‚ÇÇ and HCO‚ÇÉ‚Åª changes support the pH direction.'};
      }
      if (respSupports){
        return {primary: acid ? 'Primary respiratory acidosis' : 'Primary respiratory alkalosis', sub:'PaCO‚ÇÇ change aligns with pH.'};
      }
      if (metSupports){
        return {primary: acid ? 'Primary metabolic acidosis' : 'Primary metabolic alkalosis', sub:'HCO‚ÇÉ‚Åª change aligns with pH.'};
      }

      // If neither supports, then it's strongly suggestive of mixed.
      return {primary:'Mixed/complex', sub:'PaCO‚ÇÇ and HCO‚ÇÉ‚Åª directions do not match pH; mixed disorder likely.'};
    }

    function compensationCheck(primaryText, paco2, hco3){
      if (!isNum(paco2) || !isNum(hco3)) {
        return {title:'‚Äî', sub:'Enter PaCO‚ÇÇ and HCO‚ÇÉ‚Åª.', cls:''};
      }

      // Ranges / rules-of-thumb
      const out = {title:'‚Äî', sub:'‚Äî', cls:''};

      // Determine by keywords
      const t = (primaryText || '').toLowerCase();

      // Metabolic acidosis: Winter‚Äôs formula
      if (t.includes('metabolic acidosis')){
        const exp = 1.5*hco3 + 8;
        const lo = exp - 2, hi = exp + 2;
        const ok = paco2 >= lo && paco2 <= hi;
        if (ok){
          out.title = 'Respiratory compensation appears appropriate (Winter‚Äôs)';
          out.sub = `Expected PaCO‚ÇÇ ‚âà ${round(exp,1)} (range ${round(lo,1)}‚Äì${round(hi,1)}), observed ${round(paco2,1)}.`;
          out.cls = 'ok';
        } else if (paco2 > hi){
          out.title = 'Additional respiratory acidosis likely';
          out.sub = `Expected PaCO‚ÇÇ ${round(lo,1)}‚Äì${round(hi,1)}, observed ${round(paco2,1)} (higher than expected).`;
          out.cls = 'danger';
        } else {
          out.title = 'Additional respiratory alkalosis likely';
          out.sub = `Expected PaCO‚ÇÇ ${round(lo,1)}‚Äì${round(hi,1)}, observed ${round(paco2,1)} (lower than expected).`;
          out.cls = 'danger';
        }
        return out;
      }

      // Metabolic alkalosis
      if (t.includes('metabolic alkalosis')){
        const exp = 0.7*(hco3 - 24) + 40;
        const lo = exp - 5, hi = exp + 5;
        const ok = paco2 >= lo && paco2 <= hi;
        if (ok){
          out.title = 'Respiratory compensation appears appropriate';
          out.sub = `Expected PaCO‚ÇÇ ‚âà ${round(exp,1)} (range ${round(lo,1)}‚Äì${round(hi,1)}), observed ${round(paco2,1)}.`;
          out.cls = 'ok';
        } else if (paco2 > hi){
          out.title = 'Additional respiratory acidosis likely';
          out.sub = `Expected PaCO‚ÇÇ ${round(lo,1)}‚Äì${round(hi,1)}, observed ${round(paco2,1)} (higher than expected).`;
          out.cls = 'warn';
        } else {
          out.title = 'Additional respiratory alkalosis likely';
          out.sub = `Expected PaCO‚ÇÇ ${round(lo,1)}‚Äì${round(hi,1)}, observed ${round(paco2,1)} (lower than expected).`;
          out.cls = 'warn';
        }
        return out;
      }

      // Respiratory disorders: compute expected HCO3 for acute and chronic
      if (t.includes('respiratory acidosis') || t.includes('respiratory alkalosis')){
        const dCO2 = paco2 - 40;
        const per10 = dCO2 / 10;

        let acuteExp, chronicExp, label;
        if (t.includes('acidosis')){
          // acute: +1 per +10; chronic: +3.5 per +10
          acuteExp = 24 + 1.0*per10;
          chronicExp = 24 + 3.5*per10;
          label = 'Respiratory acidosis';
        } else {
          // acute: -2 per -10; chronic: -4 per -10
          acuteExp = 24 + (-2.0*per10);
          chronicExp = 24 + (-4.0*per10);
          label = 'Respiratory alkalosis';
        }

        // Provide ‚Äúcloseness‚Äù and mixed process hint
        const da = Math.abs(hco3 - acuteExp);
        const dc = Math.abs(hco3 - chronicExp);

        // Allow a small tolerance
        const tol = 2.0;
        const acuteClose = da <= tol;
        const chronicClose = dc <= tol;

        if (acuteClose && !chronicClose){
          out.title = `${label}: closer to acute compensation (rule-of-thumb)`;
          out.sub = `Expected HCO‚ÇÉ‚Åª acute ‚âà ${round(acuteExp,1)} (¬±${tol}), chronic ‚âà ${round(chronicExp,1)}. Observed ${round(hco3,1)}.`;
          out.cls = 'ok';
        } else if (chronicClose && !acuteClose){
          out.title = `${label}: closer to chronic compensation (rule-of-thumb)`;
          out.sub = `Expected HCO‚ÇÉ‚Åª acute ‚âà ${round(acuteExp,1)} (¬±${tol}), chronic ‚âà ${round(chronicExp,1)}. Observed ${round(hco3,1)}.`;
          out.cls = 'ok';
        } else if (acuteClose && chronicClose){
          out.title = `${label}: within both acute and chronic bands`;
          out.sub = `Expected HCO‚ÇÉ‚Åª acute ‚âà ${round(acuteExp,1)} and chronic ‚âà ${round(chronicExp,1)} (¬±${tol}). Observed ${round(hco3,1)}.`;
          out.cls = 'ok';
        } else {
          // Direction: if HCO3 higher than both expected, suggests concurrent metabolic alkalosis; if lower, concurrent metabolic acidosis
          const minExp = Math.min(acuteExp, chronicExp);
          const maxExp = Math.max(acuteExp, chronicExp);
          if (hco3 > maxExp + tol){
            out.title = `${label}: HCO‚ÇÉ‚Åª higher than expected ‚Üí concurrent metabolic alkalosis likely`;
            out.sub = `Expected HCO‚ÇÉ‚Åª ~ ${round(minExp,1)}‚Äì${round(maxExp,1)} (¬±${tol}), observed ${round(hco3,1)}.`;
            out.cls = 'warn';
          } else if (hco3 < minExp - tol){
            out.title = `${label}: HCO‚ÇÉ‚Åª lower than expected ‚Üí concurrent metabolic acidosis likely`;
            out.sub = `Expected HCO‚ÇÉ‚Åª ~ ${round(minExp,1)}‚Äì${round(maxExp,1)} (¬±${tol}), observed ${round(hco3,1)}.`;
            out.cls = 'warn';
          } else {
            out.title = `${label}: compensation atypical`;
            out.sub = `Expected HCO‚ÇÉ‚Åª acute ‚âà ${round(acuteExp,1)} and chronic ‚âà ${round(chronicExp,1)} (¬±${tol}), observed ${round(hco3,1)}.`;
            out.cls = 'warn';
          }
        }
        return out;
      }

      // Mixed/complex: provide generic note
      out.title = 'Compensation uncertain (mixed/complex pattern)';
      out.sub = 'Primary process unclear or mixed; use clinical context and consider additional labs.';
      out.cls = 'warn';
      return out;
    }

    function oxygenation(pao2, fio2){
      if (!isNum(pao2) || !isNum(fio2)) return {pfText:'‚Äî', sub:'P/F ratio shown when both entered.'};
      let f = fio2;
      if (f > 1) f = f/100;
      if (f <= 0) return {pfText:'‚Äî', sub:'Invalid FiO‚ÇÇ.'};
      const pf = pao2 / f;
      const pfText = `${round(pf,0)} (P/F)`;
      return {pfText, sub:`PaO‚ÇÇ ${round(pao2,0)} / FiO‚ÇÇ ${fmtFiO2(fio2)}.`};
    }

    function aaGradient(pao2, paco2, fio2, pb, ph2o, rq, age){
      if (!isNum(pao2) || !isNum(paco2) || !isNum(fio2)) {
        return {val:'‚Äî', sub:'Requires PaO‚ÇÇ, PaCO‚ÇÇ, FiO‚ÇÇ.'};
      }
      let f = fio2;
      if (f > 1) f = f/100;
      pb = isNum(pb) ? pb : 760;
      ph2o = isNum(ph2o) ? ph2o : 47;
      rq = isNum(rq) ? rq : 0.8;

      const PAO2 = f*(pb - ph2o) - (paco2 / rq);
      const Aa = PAO2 - pao2;

      let sub = `PAO‚ÇÇ ‚âà ${round(PAO2,0)} mmHg; A‚Äìa ‚âà ${round(Aa,0)} mmHg.`;
      if (isNum(age)){
        const exp = age/4 + 4;
        sub += ` Expected (rule-of-thumb) ‚âà ${round(exp,0)} mmHg.`;
      }
      return {val: `${round(Aa,0)} mmHg`, sub};
    }

    function anionGap(na, cl, hco3, alb){
      if (!isNum(na) || !isNum(cl) || !isNum(hco3)) return {val:'‚Äî', sub:'Requires Na, Cl, HCO‚ÇÉ.'};
      const ag = na - (cl + hco3);

      let sub = `AG = Na ‚àí (Cl + HCO‚ÇÉ) = ${round(ag,1)}.`;
      let val = `${round(ag,1)}`;

      if (isNum(alb)){
        const agc = ag + 2.5*(4.0 - alb);
        sub += ` AGcorr ‚âà ${round(agc,1)} (albumin ${round(alb,1)} g/dL).`;
        val = `${round(ag,1)} (corr ${round(agc,1)})`;

        // delta gap
        const delta = (ag - 12) / (24 - hco3);
        if (isNum(delta) && (24 - hco3) !== 0){
          sub += ` Œîgap ‚âà ${round(delta,2)} (rule-of-thumb).`;
        }
      } else {
        // delta gap still possible without albumin (less refined)
        const denom = (24 - hco3);
        if (denom !== 0){
          const delta = (ag - 12) / denom;
          if (isNum(delta)) sub += ` Œîgap ‚âà ${round(delta,2)} (rule-of-thumb).`;
        }
      }
      return {val, sub};
    }

    function buildSummary(ph, paco2, hco3, pao2, fio2, status, primary, comp, pf, aa, ag){
      const parts = [];
      parts.push(`ABG: pH ${round(ph,2)}, PaCO‚ÇÇ ${round(paco2,0)}, HCO‚ÇÉ ${round(hco3,1)}`);
      if (isNum(pao2) && isNum(fio2)) parts.push(`PaO‚ÇÇ ${round(pao2,0)} on FiO‚ÇÇ ${fmtFiO2(fio2)}`);
      parts.push(`${status.label}`);
      parts.push(`${primary.primary}`);
      if (comp && comp.title && comp.title !== '‚Äî') parts.push(comp.title);
      if (pf && pf.pfText && pf.pfText !== '‚Äî') parts.push(`P/F ${pf.pfText.replace(' (P/F)','')}`);
      if (aa && aa.val && aa.val !== '‚Äî') parts.push(`A‚Äìa ${aa.val.replace(' mmHg','')}`);
      if (ag && ag.val && ag.val !== '‚Äî') parts.push(`AG ${ag.val}`);
      return parts.join(' ‚Ä¢ ');
    }

    function recalc(){
      const ph = n(els.ph);
      const paco2 = n(els.paco2);
      const hco3 = n(els.hco3);
      const pao2 = n(els.pao2);
      let fio2 = n(els.fio2);
      if (isNum(fio2) && fio2 > 1) fio2 = fio2/100;

      const age = n(els.age);
      const pb = n(els.pb);
      const ph2o = n(els.ph2o);
      const rq = n(els.rq);

      const na = n(els.na);
      const cl = n(els.cl);
      const alb = n(els.alb);

      // Status
      const status = acidBaseStatus(ph);
      els.statusOut.textContent = status.label;
      els.statusSub.textContent = status.sub;

      // Primary
      const primary = bestFitPrimary(ph, paco2, hco3);
      els.primaryOut.textContent = primary.primary;
      els.primarySub.textContent = primary.sub;

      // Compensation
      const comp = compensationCheck(primary.primary, paco2, hco3);
      els.compOut.textContent = comp.title;
      els.compSub.textContent = comp.sub;
      els.compBadge.className = `badge ${comp.cls || ''}`.trim();
      els.compBadge.textContent = comp.cls ? (comp.cls === 'ok' ? 'Compensation: within expected band' :
                                            comp.cls === 'warn' ? 'Compensation: outside band (mixed possible)' :
                                            'Compensation: mixed process likely') : 'Awaiting inputs‚Ä¶';

      // Oxygenation
      const pf = oxygenation(pao2, fio2);
      els.pfOut.textContent = pf.pfText;
      els.oxySub.textContent = pf.sub;

      const aa = aaGradient(pao2, paco2, fio2, pb, ph2o, rq, age);
      els.aaOut.textContent = aa.val;
      els.aaSub.textContent = aa.sub;

      const ag = anionGap(na, cl, hco3, alb);
      els.agOut.textContent = ag.val;
      els.agSub.textContent = ag.sub;

      // Copy preview
      const hasCore = isNum(ph) && isNum(paco2) && isNum(hco3);
      if (!hasCore){
        els.copyPreview.textContent = 'Fill in pH, PaCO‚ÇÇ, and HCO‚ÇÉ‚Åª to generate a summary.';
        recalc._summary = '';
        return;
      }
      const summary = buildSummary(ph, paco2, hco3, pao2, fio2, status, primary, comp, pf, aa, ag);
      els.copyPreview.textContent = summary;
      recalc._summary = summary;
    }

    // Wire events
    const allInputs = [
      els.ph, els.paco2, els.hco3, els.pao2, els.fio2, els.age,
      els.pb, els.ph2o, els.rq,
      els.na, els.cl, els.alb
    ];
    allInputs.forEach(el => {
      el.addEventListener('input', recalc);
      el.addEventListener('change', recalc);
    });

    // Copy summary
    els.copyBtn.addEventListener('click', async () => {
      const text = recalc._summary || els.copyPreview.textContent || '';
      if (!text || text.startsWith('Fill in')){
        showToast('Nothing to copy yet.');
        return;
      }
      try{
        await navigator.clipboard.writeText(text);
        showToast('Copied summary to clipboard');
      } catch (e){
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Copied (fallback)');
      }
    });

    // Reset
    els.resetBtn.addEventListener('click', () => {
      els.ph.value = '';
      els.paco2.value = '';
      els.hco3.value = '';
      els.pao2.value = '';
      els.fio2.value = '';
      els.age.value = '';

      els.pb.value = 760;
      els.ph2o.value = 47;
      els.rq.value = 0.80;

      els.na.value = '';
      els.cl.value = '';
      els.alb.value = '';

      recalc();
      els.ph.focus();
      showToast('Reset');
    });

    // Footer helpers
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('scrollTop').addEventListener('click', (e) => {
      e.preventDefault();
      window.scrollTo({top: 0, behavior: 'smooth'});
    });

    // Init
    recalc();
  </script>
</body>
</html>